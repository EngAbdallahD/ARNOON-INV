<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة مخزون مطبعة ارنون</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal:not(.is-open) {
            opacity: 0;
            visibility: hidden;
        }
        .is-open {
            opacity: 1;
            visibility: visible;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="mb-8 flex flex-col sm:flex-row justify-center items-center gap-4 text-center">
            <img src="logoArnoon.png" alt="شعار مطبعة ارنون" class="h-16 sm:h-20 w-auto">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">مطبعة ارنون</h1>
                <p class="text-gray-600 mt-1">نظام إدارة المخزون</p>
                <p id="userIdDisplay" class="text-xs text-gray-500 mt-2 font-mono"></p>
            </div>
        </header>

        <!-- Controls: Search and Add Button -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <div class="relative w-full sm:w-1/2 lg:w-1/3">
                <input type="text" id="searchInput" placeholder="ابحث بالرقم التعريفي أو اسم الصنف..." class="w-full p-3 pr-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                <svg class="w-6 h-6 text-gray-400 absolute top-1/2 right-3 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <button id="addItemBtn" class="w-full sm:w-auto bg-amber-500 text-black font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-opacity-75 transition duration-300">
                <span class="ml-2">+</span> إضافة صنف جديد
            </button>
        </div>

        <!-- Inventory Table -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead class="bg-gray-50 border-b-2 border-gray-200">
                        <tr>
                            <th class="p-4 text-right font-semibold text-gray-600 tracking-wider">الرقم التعريفي</th>
                            <th class="p-4 text-right font-semibold text-gray-600 tracking-wider">اسم الصنف</th>
                            <th class="p-4 text-right font-semibold text-gray-600 tracking-wider">الكمية</th>
                            <th class="p-4 text-right font-semibold text-gray-600 tracking-wider">الوحدة</th>
                            <th class="p-4 text-center font-semibold text-gray-600 tracking-wider">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                        <!-- Loading State -->
                        <tr id="loadingState">
                            <td colspan="5" class="text-center p-8">
                                <div class="flex justify-center items-center gap-3">
                                    <svg class="animate-spin h-8 w-8 text-amber-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span class="text-gray-600 font-semibold">جاري تحميل البيانات...</span>
                                </div>
                            </td>
                        </tr>
                         <!-- Empty State -->
                        <tr id="emptyState" class="hidden">
                            <td colspan="5" class="text-center p-8">
                                <p class="text-gray-500 text-lg">لم يتم العثور على أصناف. ابدأ بإضافة صنف جديد!</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Footer with Logo -->
        <footer class="mt-12 flex justify-center">
            <img src="logoArnoon.png" alt="شعار مطبعة ارنون" class="h-12 w-auto">
        </footer>

    </div>

    <!-- Custom Alert Modal -->
    <div id="alertModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-6 text-center transform transition-all scale-95 opacity-0" id="alert-modal-content">
            <h3 id="alertTitle" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <p id="alertMessage" class="text-gray-600 mb-6"></p>
            <button id="alertOkBtn" class="bg-amber-500 text-black font-semibold py-2 px-8 rounded-lg hover:bg-amber-600 transition">موافق</button>
        </div>
    </div>
    
    <!-- Custom Confirm Modal -->
    <div id="confirmModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-6 text-center transform transition-all scale-95 opacity-0" id="confirm-modal-content">
            <h3 id="confirmTitle" class="text-xl font-bold text-gray-800 mb-4">تأكيد الحذف</h3>
            <p id="confirmMessage" class="text-gray-600 mb-6">هل أنت متأكد من رغبتك في حذف هذا الصنف؟ لا يمكن التراجع عن هذا الإجراء.</p>
            <div class="flex justify-center gap-4">
                <button id="confirmCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">إلغاء</button>
                <button id="confirmOkBtn" class="bg-red-600 text-white font-semibold py-2 px-8 rounded-lg hover:bg-red-700 transition">حذف</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-40">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md transform transition-all scale-95 opacity-0" id="modal-content">
            <div class="flex justify-between items-center p-5 border-b">
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-800">إضافة صنف جديد</h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <form id="itemForm" class="p-5 space-y-4">
                <input type="hidden" id="docId">
                <div>
                    <label for="itemName" class="block text-sm font-medium text-gray-700 mb-1">اسم الصنف</label>
                    <input type="text" id="itemName" name="itemName" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div>
                    <label for="itemQuantity" class="block text-sm font-medium text-gray-700 mb-1">الكمية</label>
                    <input type="number" id="itemQuantity" name="itemQuantity" required min="0" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div>
                    <label for="itemUnit" class="block text-sm font-medium text-gray-700 mb-1">وحدة القياس</label>
                    <select id="itemUnit" name="itemUnit" required class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="قطعة">قطعة</option>
                        <option value="كيلوجرام">كيلوجرام</option>
                        <option value="لتر">لتر</option>
                        <option value="لفة">لفة</option>
                        <option value="فرخ ورق">فرخ ورق</option>
                        <option value="علبة">علبة</option>
                    </select>
                </div>
                <div class="flex justify-end pt-4 gap-3">
                    <button type="button" id="cancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">إلغاء</button>
                    <button type="submit" id="saveBtn" class="bg-amber-500 text-black font-semibold py-2 px-6 rounded-lg hover:bg-amber-600 transition">حفظ</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase Configuration ---
        let firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'arnoon-press-inventory';

        // This special variable is provided in the collaborative environment.
        const envConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : null;

        if (envConfig && envConfig !== '{}') {
            // Use the environment's config if available
            console.log("Using environment-provided Firebase config.");
            try {
                firebaseConfig = JSON.parse(envConfig);
            } catch (e) {
                console.error("Could not parse __firebase_config:", e);
                firebaseConfig = null;
            }
        } else {
            // When running locally (e.g., in VSC), use your own Firebase project config.
            console.log("Using local Firebase config.");
            firebaseConfig = {
                apiKey: "AIzaSyBe0-x-iLz0g1DGE0F4sSEPJujS7U0Jf34",
                authDomain: "arnoon-inv.firebaseapp.com",
                projectId: "arnoon-inv",
                storageBucket: "arnoon-inv.firebasestorage.app", // Corrected storage bucket
                messagingSenderId: "1058389914747",
                appId: "1:1058389914747:web:37c8375fa95b2f331bdede",
                measurementId: "G-F4RZK8DBHL"
            };
        }

        // --- Initialize Firebase ---
        let db, auth;
        let firebaseInitialized = false;
        try {
            if (!firebaseConfig || !firebaseConfig.projectId) {
                throw new Error("إعدادات Firebase غير صالحة أو أن 'projectId' مفقود.");
            }
            
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug');
            firebaseInitialized = true;
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            const loadingStateEl = document.getElementById('loadingState');
            if (loadingStateEl) {
                loadingStateEl.innerHTML = `<td colspan="5" class="text-center p-8 text-red-500 font-bold">فشل تهيئة قاعدة البيانات. ${e.message}</td>`;
            }
        }

        // --- DOM Elements ---
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        const searchInput = document.getElementById('searchInput');
        const addItemBtn = document.getElementById('addItemBtn');
        const itemModal = document.getElementById('itemModal');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const itemForm = document.getElementById('itemForm');
        const modalTitle = document.getElementById('modalTitle');
        const saveBtn = document.getElementById('saveBtn');
        const docIdInput = document.getElementById('docId');
        const itemNameInput = document.getElementById('itemName');
        const itemQuantityInput = document.getElementById('itemQuantity');
        const itemUnitInput = document.getElementById('itemUnit');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const userIdDisplay = document.getElementById('userIdDisplay');
        
        // --- Custom Alert/Confirm Elements ---
        const alertModal = document.getElementById('alertModal');
        const alertModalContent = document.getElementById('alert-modal-content');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        const alertOkBtn = document.getElementById('alertOkBtn');
        
        const confirmModal = document.getElementById('confirmModal');
        const confirmModalContent = document.getElementById('confirm-modal-content');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmOkBtn = document.getElementById('confirmOkBtn');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');

        let inventoryData = []; // Local cache for inventory data
        let confirmCallback = null; // To store the action for confirmation

        // --- Custom Alert/Confirm Logic ---
        function showModal(modal, content) {
            modal.classList.add('is-open');
            setTimeout(() => {
                content.style.transform = 'scale(1)';
                content.style.opacity = '1';
            }, 50);
        }

        function hideModal(modal, content, onHidden) {
            content.style.transform = 'scale(0.95)';
            content.style.opacity = '0';
            setTimeout(() => {
                modal.classList.remove('is-open');
                if (onHidden) onHidden();
            }, 300);
        }

        function showAlert(title, message) {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            showModal(alertModal, alertModalContent);
        }
        alertOkBtn.addEventListener('click', () => hideModal(alertModal, alertModalContent));

        function showConfirm(title, message, callback) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmCallback = callback;
            showModal(confirmModal, confirmModalContent);
        }
        
        confirmOkBtn.addEventListener('click', () => {
            if (confirmCallback) confirmCallback(true);
            hideModal(confirmModal, confirmModalContent);
            confirmCallback = null;
        });

        confirmCancelBtn.addEventListener('click', () => {
            if (confirmCallback) confirmCallback(false);
            hideModal(confirmModal, confirmModalContent);
            confirmCallback = null;
        });

        // --- Item Form Modal Logic ---
        function openItemModal() {
            showModal(itemModal, modalContent);
        }

        function closeItemModal() {
            hideModal(itemModal, modalContent, () => {
                itemForm.reset();
                docIdInput.value = '';
            });
        }

        addItemBtn.addEventListener('click', () => {
            modalTitle.textContent = 'إضافة صنف جديد';
            saveBtn.textContent = 'حفظ';
            itemForm.reset();
            docIdInput.value = '';
            openItemModal();
        });

        closeModalBtn.addEventListener('click', closeItemModal);
        cancelBtn.addEventListener('click', closeItemModal);
        itemModal.addEventListener('click', (e) => {
            if (e.target === itemModal) {
                closeItemModal();
            }
        });

        // --- Render Table ---
        function renderTable(items) {
            inventoryTableBody.innerHTML = ''; // Clear existing rows
            loadingState.classList.add('hidden');

            if (items.length === 0) {
                emptyState.classList.remove('hidden');
                inventoryTableBody.appendChild(emptyState);
                return;
            }
            emptyState.classList.add('hidden');

            // Sort items by name for consistent order
            items.sort((a, b) => a.name.localeCompare(b.name, 'ar'));

            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-200 hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="p-4 text-gray-800 font-mono text-sm">${item.id || 'N/A'}</td>
                    <td class="p-4 text-gray-800 font-semibold">${item.name}</td>
                    <td class="p-4 text-gray-800">${item.quantity}</td>
                    <td class="p-4 text-gray-600">${item.unit}</td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center items-center gap-2">
                            <button data-id="${item.docId}" class="edit-btn p-2 text-amber-600 hover:text-amber-800 rounded-full hover:bg-amber-100 transition" aria-label="تعديل">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                            </button>
                            <button data-id="${item.docId}" class="delete-btn p-2 text-red-600 hover:text-red-800 rounded-full hover:bg-red-100 transition" aria-label="حذف">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </td>
                `;
                inventoryTableBody.appendChild(tr);
            });
        }

        // --- Search/Filter Logic ---
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredItems = inventoryData.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                (item.id && item.id.toLowerCase().includes(searchTerm))
            );
            renderTable(filteredItems);
        });

        // --- Firebase Firestore Logic ---
        function setupAppForUser(userId) {
            // **CHANGE**: Data is now stored in a public path, shared by all users of this app.
            const collectionPath = `artifacts/${appId}/public/data/inventory`;
            
            // Display User ID for debugging, but it no longer determines the data path.
            userIdDisplay.textContent = `User ID: ${userId}`;

            // Firestore real-time listener
            onSnapshot(itemsCollection, (snapshot) => {
                inventoryData = snapshot.docs.map(doc => ({
                    docId: doc.id,
                    ...doc.data()
                }));
                renderTable(inventoryData);
                searchInput.dispatchEvent(new Event('input')); // Re-apply search filter
            }, (error) => {
                console.error("Error fetching inventory: ", error);
                showAlert("خطأ فادح", "حدث خطأ أثناء تحميل البيانات. قد تحتاج إلى تحديث الصفحة.");
                inventoryTableBody.innerHTML = `<td colspan="5" class="text-center p-8 text-red-500">حدث خطأ أثناء تحميل البيانات.</td>`;
            });

            // --- Form Submission (Add/Edit) ---
            itemForm.onsubmit = async (e) => {
                e.preventDefault();
                saveBtn.disabled = true;
                saveBtn.textContent = 'جاري الحفظ...';

                const docId = docIdInput.value;
                const itemData = {
                    name: itemNameInput.value,
                    quantity: Number(itemQuantityInput.value),
                    unit: itemUnitInput.value,
                    updatedAt: serverTimestamp(),
                };

                try {
                    const itemsCollection = collection(db, collectionPath);
                    if (docId) { // Editing existing item
                        const itemRef = doc(db, collectionPath, docId);
                        await setDoc(itemRef, itemData, { merge: true });
                    } else { // Adding new item
                        itemData.id = `ITEM-${Date.now()}`; // Simple unique ID
                        itemData.createdAt = serverTimestamp();
                        await addDoc(itemsCollection, itemData);
                    }
                    closeItemModal();
                } catch (error) {
                    console.error("Error saving item: ", error);
                    showAlert("خطأ في الحفظ", `حدث خطأ: ${error.message}. تأكد من أن قواعد الأمان في Firestore صحيحة.`);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'حفظ';
                }
            };

            // --- Event Delegation for Edit/Delete ---
            inventoryTableBody.onclick = async (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                const docId = target.dataset.id;
                if (!docId) return;
                
                const itemsCollection = collection(db, collectionPath);

                if (target.classList.contains('delete-btn')) {
                    showConfirm('تأكيد الحذف', 'هل أنت متأكد من رغبتك في حذف هذا الصنف؟', async (confirmed) => {
                        if (confirmed) {
                            try {
                                await deleteDoc(doc(db, collectionPath, docId));
                            } catch (error) {
                                console.error("Error deleting item: ", error);
                                showAlert("خطأ في الحذف", `حدث خطأ: ${error.message}`);
                            }
                        }
                    });
                }

                if (target.classList.contains('edit-btn')) {
                    const itemToEdit = inventoryData.find(item => item.docId === docId);
                    if (itemToEdit) {
                        modalTitle.textContent = 'تعديل الصنف';
                        saveBtn.textContent = 'تحديث';
                        docIdInput.value = itemToEdit.docId;
                        itemNameInput.value = itemToEdit.name;
                        itemQuantityInput.value = itemToEdit.quantity;
                        itemUnitInput.value = itemToEdit.unit;
                        openItemModal();
                    }
                }
            };
        }

        // --- Firebase Authentication ---
        if (firebaseInitialized) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in.
                    setupAppForUser(user.uid);
                } else {
                    // User is signed out. Try to sign in.
                    try {
                        // For local development, __initial_auth_token will be undefined.
                        // In that case, we fall back to anonymous sign-in.
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        let userMessage = "لا يمكن تحميل البيانات. يرجى التحقق من اتصالك بالإنترنت وتحديث الصفحة.";
                        let errorTitle = "فشل المصادقة";

                        if (error.code === 'auth/custom-token-mismatch') {
                            errorTitle = "خطأ في تطابق الإعدادات";
                            userMessage = "فشل المصادقة بسبب عدم تطابق إعدادات Firebase. تم تحديث الكود لاستخدام الإعدادات الصحيحة. يرجى تحديث الصفحة.";
                        } else if (error.code === 'auth/configuration-not-found') {
                            errorTitle = "خطأ في الإعدادات";
                            userMessage = "فشل المصادقة لأن طريقة تسجيل الدخول 'المجهولة' (Anonymous) غير مُفعَّلة في مشروع Firebase. يرجى تفعيلها من لوحة التحكم والمحاولة مرة أخرى.";
                        }

                        showAlert(errorTitle, userMessage);
                        document.getElementById('loadingState').innerHTML = `<td colspan="5" class="text-center p-8 text-red-500 font-bold">${userMessage}</td>`;
                    }
                }
            });
        }

    </script>
</body>
</html>
